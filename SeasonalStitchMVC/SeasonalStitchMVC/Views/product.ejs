<!DOCTYPE html>
<html>
<head>
    <title><%= hoodie.name %> - Seasonal Stitch</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="brand">Seasonal Stitch</a>
        <div class="nav-links">
            <% if (user && user.role === 'admin') { %>
                <a class="<%= activePage === 'dashboard' ? 'active' : '' %>" href="/admin/dashboard">Dashboard</a>
                <a class="<%= activePage === 'orders' ? 'active' : '' %>" href="/admin/orders">Orders</a>
                <a class="<%= activePage === 'inventory' ? 'active' : '' %>" href="/inventory">Inventory</a>
                <a class="<%= activePage === 'users' ? 'active' : '' %>" href="/admin/users">Users</a>
                <a class="<%= activePage === 'reports' ? 'active' : '' %>" href="/admin/reports">Reports</a>
                <a class="nav-pill" href="/stitchybank">Stitches: <%= stitchesBalance || 0 %></a>
                <span class="nav-welcome center">Welcome, <%= user.full_name %></span>
                <a href="/logout">Logout</a>
            <% } else if (user) { %>
                <a class="<%= activePage === 'shop' ? 'active' : '' %>" href="/#shop">Shop</a>
                <a class="<%= activePage === 'cart' ? 'active' : '' %>" href="/cart">Cart (<%= cartCount %>)</a>
                <a class="<%= activePage === 'orders' ? 'active' : '' %>" href="/orders">
                    Orders
                    <% if (reviewableCount && reviewableCount > 0) { %>
                        <span class="nav-badge"><%= reviewableCount %></span>
                    <% } %>
                </a>
                <a class="nav-pill" href="/stitchybank">Stitches: <%= stitchesBalance || 0 %></a>
                <span class="nav-pill secondary">Profile</span>
                <span class="nav-welcome center">Welcome, <%= user.full_name %></span>
                <a href="/logout">Logout</a>
            <% } else { %>
                <a href="/#hero">Home</a>
                <a href="/#shop">Shop</a>
                <a href="/login">Login</a>
                <a href="/register">Register</a>
            <% } %>
        </div>
    </nav>

    <div class="container">
        <div class="form-container form-wide">
            <div class="admin-header">
                <div>
                    <h2><%= hoodie.name %></h2>
                    <p class="order-muted">Average Rating: <%= Number(reviewStats.avg || 0).toFixed(1) %> / 5</p>
                    <p class="order-muted">Reviews: <%= reviewStats.count || 0 %></p>
                </div>
                <a href="/" class="btn btn-outline">Back to Shop</a>
            </div>
            <div class="hoodies-grid">
                <div class="hoodie-card">
                    <img src="/images/<%= hoodie.image_url %>" alt="<%= hoodie.name %>">
                    <div class="hoodie-info">
                        <p class="price">$<%= Number(hoodie.price).toFixed(2) %></p>
                        <p class="order-muted"><%= hoodie.description %></p>
                        <% if (user && user.role !== 'admin') { %>
                            <form action="/cart/add/<%= hoodie.hoodie_id %>" method="post" class="cart-add-form">
                                <input type="hidden" name="quantity" value="1" />
                                <button type="submit" class="btn btn-primary">Add to Cart</button>
                            </form>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-container form-wide">
            <h3>Customer Reviews</h3>
            <% if (!reviews || reviews.length === 0) { %>
                <p class="order-muted">No reviews yet.</p>
            <% } else { %>
                <div class="option-group" id="review-tags">
                    <button type="button" class="btn btn-ghost btn-compact" data-tag="all">All</button>
                    <button type="button" class="btn btn-ghost btn-compact" data-tag="Product Quality">Product Quality</button>
                    <button type="button" class="btn btn-ghost btn-compact" data-tag="True to product images">True to product images</button>
                    <button type="button" class="btn btn-ghost btn-compact" data-tag="Fabric Material">Fabric Material</button>
                    <button type="button" class="btn btn-ghost btn-compact" data-tag="Comfort">Comfort</button>
                </div>

                <div class="orders-grid" id="review-list">
                    <% reviews.forEach((review, idx) => { %>
                        <div class="order-card review-card" data-tags="<%= review.tags || '' %>" data-index="<%= idx %>">
                            <div class="order-card-header">
                                <div>
                                    <p class="order-label"><%= review.full_name || 'Customer' %></p>
                                    <h3><%= review.rating %> / 5</h3>
                                </div>
                                <div class="order-meta">
                                    <span class="order-date"><%= new Date(review.created_at).toLocaleDateString() %></span>
                                </div>
                            </div>
                            <% if (review.overall_fit) { %>
                                <p class="order-muted"><strong>Fit:</strong> <%= review.overall_fit %></p>
                            <% } %>
                            <% if (review.tags) { %>
                                <p class="order-muted"><strong>Tags:</strong> <%= review.tags %></p>
                            <% } %>
                            <% if (review.review_text) { %>
                                <p><%= review.review_text %></p>
                            <% } %>
                        </div>
                    <% }); %>
                </div>

                <div class="admin-controls center">
                    <button type="button" id="toggle-reviews" class="btn btn-outline">Read more</button>
                </div>
            <% } %>
        </div>
    </div>
    <%- include('partials/footer') %>

    <script>
        const reviewCards = Array.from(document.querySelectorAll('.review-card'));
        const toggleBtn = document.getElementById('toggle-reviews');
        const tagButtons = document.querySelectorAll('#review-tags [data-tag]');
        let expanded = false;
        let currentTag = 'all';

        const applyFilters = () => {
            let visibleCount = 0;
            reviewCards.forEach((card) => {
                const tags = (card.dataset.tags || '').split(',').map((t) => t.trim()).filter(Boolean);
                const matches = currentTag === 'all' || tags.includes(currentTag);
                if (!matches) {
                    card.style.display = 'none';
                    return;
                }
                visibleCount += 1;
                if (!expanded && visibleCount > 3) {
                    card.style.display = 'none';
                } else {
                    card.style.display = 'block';
                }
            });

            if (toggleBtn) {
                toggleBtn.style.display = visibleCount > 3 ? 'inline-flex' : 'none';
                toggleBtn.textContent = expanded ? 'Hide reviews' : 'Read more';
            }
        };

        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                expanded = !expanded;
                applyFilters();
            });
        }

        tagButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                currentTag = btn.dataset.tag || 'all';
                expanded = false;
                applyFilters();
            });
        });

        applyFilters();
    </script>
</body>
</html>
