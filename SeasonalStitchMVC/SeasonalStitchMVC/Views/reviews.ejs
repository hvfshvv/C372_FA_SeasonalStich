<!DOCTYPE html>
<html>
<head>
    <title>Leave a Review - Seasonal Stitch</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="brand">Seasonal Stitch</a>
        <div class="nav-links">
            <a class="<%= activePage === 'shop' ? 'active' : '' %>" href="/#shop">Shop</a>
            <a class="<%= activePage === 'cart' ? 'active' : '' %>" href="/cart">Cart (<%= cartCount %>)</a>
            <a class="<%= activePage === 'orders' ? 'active' : '' %>" href="/orders">
                Orders
                <% if (reviewableCount && reviewableCount > 0) { %>
                    <span class="nav-badge"><%= reviewableCount %></span>
                <% } %>
            </a>
            <a class="nav-pill" href="/stitchybank">Stitches: <%= stitchesBalance || 0 %></a>
            <span class="nav-pill secondary">Profile</span>
            <span class="nav-welcome center">Welcome, <%= user.full_name %></span>
            <a href="/logout">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="form-container form-wide">
            <h2>Leave a Review</h2>
            <p class="order-muted">Order #<%= order.order_id %> Â· Delivered</p>

            <% if (!products || products.length === 0) { %>
                <div class="empty-state">
                    <p>No products available to review.</p>
                </div>
            <% } else { %>
                <div class="status-control" id="review-tabs">
                    <% products.forEach(product => { %>
                        <% const reviewed = existingReviews && existingReviews[product.hoodie_id]; %>
                        <button
                            type="button"
                            class="btn btn-outline btn-compact"
                            data-hoodie="<%= product.hoodie_id %>"
                            <%= reviewed ? 'disabled' : '' %>
                        >
                            <%= product.name %>
                            <% if (reviewed) { %>
                                (Reviewed)
                            <% } %>
                        </button>
                    <% }); %>
                </div>

                <form id="reviews-form" action="/orders/<%= order.order_id %>/reviews" method="post" class="form-group">
                    <input type="hidden" id="reviews_payload" name="reviews_payload" value="[]">

                    <div class="admin-header">
                        <div>
                            <h3 id="product-name"></h3>
                            <p class="order-muted" id="reviewed-note" style="display: none;">Already reviewed.</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="rating">Rating</label>
                        <select id="rating" name="rating" required>
                            <option value="">Select rating</option>
                            <option value="5">5 - Excellent</option>
                            <option value="4">4 - Good</option>
                            <option value="3">3 - Okay</option>
                            <option value="2">2 - Poor</option>
                            <option value="1">1 - Terrible</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tags</label>
                        <div class="option-group">
                            <% tags.forEach(tag => { %>
                                <label>
                                    <input type="checkbox" name="tags" value="<%= tag %>">
                                    <%= tag %>
                                </label>
                            <% }); %>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="overall_fit">Overall Fit</label>
                        <select id="overall_fit" name="overall_fit">
                            <option value="">Select fit</option>
                            <% fitOptions.forEach(option => { %>
                                <option value="<%= option %>"><%= option %></option>
                            <% }); %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="Share your thoughts..."></textarea>
                    </div>

                    <div class="admin-controls">
                        <a href="/orders" class="btn btn-outline">Back to Orders</a>
                        <button type="submit" class="btn btn-primary">Submit All Reviews</button>
                    </div>
                </form>
            <% } %>
        </div>
    </div>
    <%- include('partials/footer') %>

    <script>
        const products = <%- JSON.stringify(products || []) %>;
        const existingReviews = <%- JSON.stringify(existingReviews || {}) %>;
        const drafts = {};
        let currentId = products.length ? String(products[0].hoodie_id) : null;

        const form = document.getElementById('reviews-form');
        const nameEl = document.getElementById('product-name');
        const reviewedNote = document.getElementById('reviewed-note');
        const ratingEl = document.getElementById('rating');
        const fitEl = document.getElementById('overall_fit');
        const notesEl = document.getElementById('notes');
        const tagsEls = () => Array.from(document.querySelectorAll('input[name="tags"]'));

        const setFormDisabled = (disabled) => {
            ratingEl.disabled = disabled;
            fitEl.disabled = disabled;
            notesEl.disabled = disabled;
            tagsEls().forEach((el) => { el.disabled = disabled; });
        };

        const getTagValues = () => tagsEls().filter((el) => el.checked).map((el) => el.value);

        const saveDraft = (hoodieId) => {
            if (!hoodieId || existingReviews[hoodieId]) return;
            drafts[hoodieId] = {
                hoodie_id: hoodieId,
                rating: ratingEl.value,
                tags: getTagValues(),
                overall_fit: fitEl.value,
                notes: notesEl.value
            };
        };

        const loadDraft = (hoodieId) => {
            const product = products.find((p) => String(p.hoodie_id) === String(hoodieId));
            if (!product) return;
            nameEl.textContent = product.name;

            if (existingReviews[hoodieId]) {
                const review = existingReviews[hoodieId];
                reviewedNote.style.display = 'block';
                ratingEl.value = String(review.rating || '');
                fitEl.value = review.overall_fit || '';
                notesEl.value = review.review_text || '';
                tagsEls().forEach((el) => {
                    const tags = String(review.tags || '').split(',').map((t) => t.trim()).filter(Boolean);
                    el.checked = tags.includes(el.value);
                });
                setFormDisabled(true);
                return;
            }

            reviewedNote.style.display = 'none';
            const draft = drafts[hoodieId] || {};
            ratingEl.value = draft.rating || '';
            fitEl.value = draft.overall_fit || '';
            notesEl.value = draft.notes || '';
            tagsEls().forEach((el) => {
                el.checked = (draft.tags || []).includes(el.value);
            });
            setFormDisabled(false);
        };

        const tabs = document.querySelectorAll('#review-tabs [data-hoodie]');
        tabs.forEach((btn) => {
            btn.addEventListener('click', () => {
                const nextId = String(btn.dataset.hoodie || '');
                if (!nextId || nextId === currentId) return;
                saveDraft(currentId);
                currentId = nextId;
                loadDraft(currentId);
            });
        });

        if (currentId) {
            loadDraft(currentId);
        }

        if (form) {
            form.addEventListener('submit', (e) => {
                if (!currentId) return;
                saveDraft(currentId);
                const payload = Object.values(drafts).filter((d) => d.rating);
                if (payload.length === 0) {
                    e.preventDefault();
                    alert('Please add at least one rating before submitting.');
                    return;
                }
                document.getElementById('reviews_payload').value = JSON.stringify(payload);
            });
        }
    </script>
</body>
</html>
